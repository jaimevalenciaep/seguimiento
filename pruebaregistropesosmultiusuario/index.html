<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="./favicon-512x512.png" />
  <title>Registro diario de peso (Nutrición)</title>
  <meta name="description" content="Página para registrar peso corporal diario con fecha editable (por defecto hoy). Guarda en Google Sheets por cliente." />
  <style>
    /* Imágenes globales responsivas */
    img{max-width:100%; height:auto; display:block}

    :root{
      /* Paleta JV (azules) */
      --bg:#0b1220;          /* fondo principal (navy oscuro) */
      --card:#0f1726;        /* tarjetas */
      --muted:#a8c3e6;       /* texto secundario */
      --text:#eaf2ff;        /* texto principal */
      --accent:#17b2ff;      /* azul neón */
      --accent-2:#0f7fe6;    /* azul profundo */
      --danger:#d95252;      /* rojo */
      --border:#1e2a3f;      /* bordes */
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif;
      background:
        radial-gradient(60% 40% at 20% 0%, rgba(23,178,255,.25), transparent 60%),
        linear-gradient(180deg, #0b1220, #0c1524 40%, #0b1220);
      color:var(--text);
      overflow-x:hidden;
    }
    .container{max-width:820px; margin:0 auto; padding:24px;}

    /* ===== Header con imagen (título) + badges ===== */
    header.brand{
      display:grid;
      grid-template-columns: 1fr auto; /* imagen a la izq., badges a la dcha. */
      grid-auto-rows:auto;
      gap:8px 12px;
      align-items:center;
      margin-bottom:8px;
    }
    .brand-hero{
      max-width:clamp(220px, 60vw, 520px);
      height:auto;
      filter: drop-shadow(0 0 18px rgba(23,178,255,.35));
      justify-self:start;
    }
    .brand-aside{display:grid; gap:6px; justify-items:end}
    .badge{font-size:.85rem; padding:6px 10px; border:1px solid var(--border); border-radius:999px; color:#cfe9ff; background:rgba(23,178,255,.08)}
    .status-ok{border-color:#174a7a; background:#0b2a44}
    .status-local{border-color:#2b4f7a; background:#0f253d}
    .status-error{border-color:#6b2c2c; background:#361112; color:#ffd7d7}

    @media (max-width:560px){
      header.brand{grid-template-columns:1fr}
      .brand-aside{justify-items:start}
      .brand-hero{max-width:min(82vw, 420px)}
    }

    /* Tarjetas / inputs / tabla */
    .card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:16px; box-shadow: 0 10px 30px rgb(0 0 0 / 25%);}
    .stack{display:grid; gap:12px}
    label{font-weight:600; color:#d1d9e0}
    input[type="number"], input[type="text"], input[type="date"], .fake-input{
      width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--border); background:#0b1526; color:var(--text);
      outline:none; transition: box-shadow .15s ease, border-color .15s ease;
    }
    input:focus{box-shadow:0 0 0 3px rgba(92,200,255,.35); border-color:var(--accent-2)}
    .row{display:grid; grid-template-columns:1fr; gap:12px}
    @media (min-width:640px){ .row{ grid-template-columns: 1fr 1fr; } }

    .actions{display:flex; gap:8px; flex-wrap:wrap;}
    button{
      background:#16212e; border:1px solid var(--border); color:var(--text); padding:10px 14px; border-radius:12px; cursor:pointer;
      font-weight:600; letter-spacing:.2px; min-height:40px;
    }
    button:hover{filter:brightness(1.08)}
    .btn-primary{background:linear-gradient(180deg, var(--accent), var(--accent-2)); border-color:var(--accent-2)}
    .btn-ghost{background:transparent}

    .toolbar{display:flex; gap:8px; align-items:center; justify-content:space-between; margin-top:8px; flex-wrap:wrap;}

    table{width:100%; border-collapse:separate; border-spacing:0 8px;}
    thead th{font-size:.92rem; color:#c6d9f2; font-weight:700; text-align:left; padding:10px 8px}
    tbody td{background:#0a1424; border-top:1px solid #1a2740; border-bottom:1px solid #1a2740; padding:12px 8px; vertical-align:middle}
    tbody tr td:first-child{border-left:1px solid #172231; border-top-left-radius:12px; border-bottom-left-radius:12px}
    tbody tr td:last-child{border-right:1px solid #172231; border-top-right-radius:12px; border-bottom-right-radius:12px}
    tbody tr:hover td{background:#0c1a2e}

    .table-actions button{padding:6px 10px; font-size:.9rem}
    .muted{color:var(--muted)}
    .right{text-align:right}

    .toast{position:fixed; right:16px; bottom:16px; background:#111a24; color:var(--text); border:1px solid var(--border); padding:10px 14px; border-radius:12px; box-shadow:0 10px 20px rgb(0 0 0 / 30%)}
    .sr-only{position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0}

    /* Marca de agua sutil */
    body::after{content:""; position:fixed; inset:0; pointer-events:none; background: url('./logo-invertido-fondo-oscuro.png') no-repeat right -80px top -60px; background-size: 360px auto; opacity:.05}
  </style>
</head>
<body>
  <div class="container">
    <header class="brand">
      <!-- Título como imagen -->
      <img
        id="brand-hero"
        class="brand-hero"
        src="./logo-principal-encabezado-web-invertido.png"
        alt="Jaime Valencia — Entrenamiento Personal, Nutrición y Programación Online"
      />
      <div class="brand-aside">
        <div class="badge" id="status-badge" aria-live="polite">Inicializando…</div>
        <div class="badge" id="cliente-badge" aria-live="polite" style="display:none"></div>
      </div>
    </header>

    <h1 class="sr-only">Registro diario de peso</h1>

    <section class="card" aria-labelledby="form-title">
      <h2 id="form-title" class="sr-only">Añadir registro</h2>
      <div class="stack">
        <div class="row">
          <div>
            <label for="fecha">Fecha</label>
            <input id="fecha" type="date" aria-label="Fecha" />
          </div>
          <div>
            <label for="peso">Peso corporal (kg)</label>
            <input id="peso" type="number" inputmode="decimal" step="0.1" min="0" placeholder="Ej.: 72.3" aria-describedby="peso-help" />
            <div class="muted" id="peso-help">La fecha puedes cambiarla. Introduce solo el peso en kg.</div>
          </div>
        </div>
        <div class="actions">
          <button class="btn-primary" id="add-btn">Añadir</button>
        </div>
      </div>
    </section>

    <section class="card" style="margin-top:12px" aria-labelledby="tabla-title">
      <h2 id="tabla-title" class="sr-only">Registros</h2>
      <div class="toolbar">
        <div class="lhs muted">Orden: más recientes primero</div>
      </div>
      <div style="overflow:auto; margin-top:8px; -webkit-overflow-scrolling:touch">
        <table aria-describedby="tabla-title">
          <thead>
            <tr>
              <th>Fecha</th>
              <th class="right">Peso (kg)</th>
              <th class="right">Acciones</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite" style="display:none"></div>

  <noscript><div class="container"><p>Esta aplicación requiere JavaScript para funcionar.</p></div></noscript>

  <script>
  /* ======================= CONFIGURACIÓN ======================= */
  const CONFIG = { 
    BACKEND_URL: "https://script.google.com/macros/s/AKfycbzt9_5QGvPyDPgqid0Vk2Gmr2ar-TBaGxnmumJ69korWeYyhfP3c4-rdLnCOIj_Jgrr/exec",
    STORAGE_MODE: 'backend',      // forzado a backend
    CLIENTE_ID: ""                // se completa con ?cliente=... o ?client_id=...
  };

  /* ======================= UTILIDADES ======================= */
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const genId = () => (typeof crypto!=='undefined' && crypto.randomUUID) ? crypto.randomUUID() : ('id_'+Math.random().toString(36).slice(2,10));

  function toDDMMYYYY(d){
    const dt = (d instanceof Date) ? d : new Date(d);
    const dd = String(dt.getDate()).padStart(2,'0');
    const mm = String(dt.getMonth()+1).padStart(2,'0');
    const yyyy = dt.getFullYear();
    return `${dd}/${mm}/${yyyy}`;
  }
  function parseDDMMYYYY(str){
    const m = String(str||'').match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
    if(!m) return null;
    const [_, dd, mm, yyyy] = m;
    const date = new Date(Number(yyyy), Number(mm)-1, Number(dd));
    return isNaN(date) ? null : date;
  }
  function toYMD(d){
    const dt = (d instanceof Date) ? d : new Date(d);
    const dd = String(dt.getDate()).padStart(2,'0');
    const mm = String(dt.getMonth()+1).padStart(2,'0');
    const yyyy = dt.getFullYear();
    return `${yyyy}-${mm}-${dd}`;
  }
  function ymdToDDMMYYYY(s){
    const m = String(s||'').match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if(!m) return null;
    const [, yyyy, mm, dd] = m;
    return `${dd}/${mm}/${yyyy}`;
  }
  function parseWeight(input){
    if(input===null || input===undefined) return NaN;
    const s = String(input).replace(',', '.').trim();
    return Number(s);
  }
  function sanitizeClienteId(s){
    return String(s||'').toLowerCase().replace(/[^a-z0-9_-]/g,'').slice(0,64);
  }
  function showToast(msg, kind='info'){
    const el = $('#toast'); if(!el) return;
    el.textContent = msg;
    el.style.display = 'block';
    el.style.borderColor = kind==='error' ? '#7c2e2e' : (kind==='warn' ? '#8b6b20' : 'var(--border)');
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=>{ el.style.display='none'; }, 3500);
  }
  // Errores globales
  window.addEventListener('error', (e)=>{ try{ showToast('Error: '+(e.error?.message||e.message), 'error'); }catch(_){} });
  window.addEventListener('unhandledrejection', (e)=>{ try{ showToast('Error: '+(e.reason?.message||e.reason), 'error'); }catch(_){} });

  /* ======================= ADAPTADOR GOOGLE SHEETS ======================= */
  function withCliente(payload){
    const p = {...payload};
    const cid = (CONFIG.CLIENTE_ID||'').trim();
    if(cid) p.cliente = cid;
    return p;
  }
  function createSheetsAdapter(url){
    async function api(payload){
      const ctrl = new AbortController();
      const t = setTimeout(()=> ctrl.abort(), 20000);
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // evita preflight CORS
        body: JSON.stringify(payload),
        signal: ctrl.signal,
        mode: 'cors',
        redirect: 'follow'
      });
      clearTimeout(t);
      if(!res.ok) throw new Error('HTTP '+res.status);
      const text = await res.text();
      let json; try{ json = JSON.parse(text); }catch(_){ throw new Error('Respuesta no-JSON del backend'); }
      if(!json.ok) throw new Error(json.error || 'Error backend');
      return json.data;
    }
    return {
      id: 'backend',
      async list(){ return api(withCliente({action:'list'})); },
      async add(entry){ return api(withCliente({action:'add', entry})); },
      async update(id, patch){ return api(withCliente({action:'update', id, ...patch})); },
      async remove(id){ return api(withCliente({action:'delete', id})); }
    };
  }
  function pickAdapter(){ return createSheetsAdapter((CONFIG.BACKEND_URL||'').trim()); }

  /* ======================= APP ======================= */
  const state = { entries: [], adapter: null };

  function setStatus(kind, text){
    const el = $('#status-badge'); if(!el) return;
    el.classList.remove('status-ok','status-local','status-error');
    if(kind==='backend'){ el.classList.add('status-ok'); el.textContent = 'Guardando en: Google Sheets'; }
    else if(kind==='local'){ el.classList.add('status-local'); el.textContent = 'Guardando en: Este dispositivo'; }
    else { el.classList.add('status-error'); el.textContent = text || 'Error de almacenamiento'; }
  }

  function render(){
    const tbody = $('#tbody'); if(!tbody) return;
    tbody.innerHTML = '';
    const sorted = [...state.entries].sort((a,b)=>{
      const ai = a.iso ? Date.parse(a.iso) : (parseDDMMYYYY(a.fecha)||new Date(0));
      const bi = b.iso ? Date.parse(b.iso) : (parseDDMMYYYY(b.fecha)||new Date(0));
      return bi - ai;
    });
    for(const e of sorted){
      const tr = document.createElement('tr'); tr.dataset.id = e.id;
      const tdF = document.createElement('td'); tdF.textContent = e.fecha;
      const tdP = document.createElement('td'); tdP.className = 'right'; tdP.textContent = Number(e.peso).toFixed(1);
      const tdA = document.createElement('td'); tdA.className = 'right table-actions'; tdA.innerHTML = '<button class="btn-ghost" data-action="edit">Editar</button> <button class="btn-ghost" data-action="delete">Eliminar</button>';
      tr.append(tdF, tdP, tdA); tbody.appendChild(tr);
    }
  }

  async function loadEntries(adapter){
    try{
      const list = await adapter.list();
      state.entries = Array.isArray(list) ? list : [];
      render();
      setStatus('backend');
    }catch(err){
      console.error('Fallo list()', err);
      setStatus('error', 'Error conectando con Google Sheets');
      showToast('No se pudo conectar con Google Sheets. Revisa la URL y permisos del Web App.', 'error');
    }
  }

  async function addEntry(){
    const pesoInput = $('#peso');
    const fechaInput = $('#fecha');
    const peso = parseWeight(pesoInput?.value);
    if(!(peso>0)){
      showToast('Introduce un peso válido (> 0).', 'error');
      pesoInput?.focus();
      return;
    }
    const now = new Date();
    const fechaYMD = fechaInput && fechaInput.value ? fechaInput.value : toYMD(now);
    const fechaStr = ymdToDDMMYYYY(fechaYMD) || toDDMMYYYY(now);

    const baseId = genId();
    const compositeId = CONFIG.CLIENTE_ID ? `${CONFIG.CLIENTE_ID}:${baseId}` : baseId;
    const entry = { id: compositeId, fecha: fechaStr, peso: Number(peso.toFixed(1)), iso: now.toISOString() };

    try{
      await state.adapter.add(entry);
      state.entries.push(entry);
      pesoInput.value = '';
      render();
      showToast('Registro añadido.');
    }catch(err){
      console.error('add failed', err);
      showToast('No se pudo guardar el registro.', 'error');
    }
  }

  function startEdit(id){
    const tr = document.querySelector(`tr[data-id="${id}"]`);
    if(!tr) return;
    const tdPeso = tr.children[1];
    const tdAct = tr.children[2];
    const curr = tdPeso.textContent;
    tdPeso.innerHTML = '<input type="number" step="0.1" min="0" value="'+curr+'" style="width:120px" aria-label="Peso" />';
    tdAct.innerHTML = '<button class="btn-ghost" data-action="save">Guardar</button> <button class="btn-ghost" data-action="cancel">Cancelar</button>';
  }
  async function saveEdit(id){
    const tr = document.querySelector(`tr[data-id="${id}"]`);
    if(!tr) return;
    const input = tr.querySelector('input[type="number"]');
    const peso = parseWeight(input.value);
    if(!(peso>0)){ showToast('Peso inválido.', 'error'); input.focus(); return; }
    try{
      await state.adapter.update(id, {peso: Number(peso.toFixed(1))});
      const idx = state.entries.findIndex(e=>e.id===id);
      if(idx>-1){ state.entries[idx].peso = Number(peso.toFixed(1)); state.entries[idx].iso = new Date().toISOString(); }
      render();
      showToast('Registro actualizado.');
    }catch(err){ console.error(err); showToast('No se pudo actualizar.', 'error'); }
  }
  function cancelEdit(){ render(); }

  async function deleteEntry(id){
    if(!confirm('¿Seguro que deseas eliminar este registro?')) return;
    try{
      await state.adapter.remove(id);
      state.entries = state.entries.filter(e=>e.id!==id);
      render();
      showToast('Registro eliminado.');
    }catch(err){ console.error(err); showToast('No se pudo eliminar.', 'error'); }
  }

  // Delegación de eventos en la tabla
  document.addEventListener('click', (ev)=>{
    const btn = ev.target.closest('button'); if(!btn) return;
    const tr = ev.target.closest('tr'); const id = tr?.dataset?.id; const action = btn.dataset.action;
    if(action==='edit') startEdit(id);
    if(action==='save') saveEdit(id);
    if(action==='cancel') cancelEdit();
    if(action==='delete') deleteEntry(id);
  });

  // Botón principal
  $('#add-btn')?.addEventListener('click', (e)=>{ e.preventDefault(); addEntry(); });

  // Inicialización
  (async function init(){
    // Fallback si la imagen del encabezado no existe
    const hero = document.getElementById('brand-hero');
    if(hero){
      hero.addEventListener('error', ()=>{
        try{ showToast('No se encontró la imagen del encabezado. Uso logo alternativo.', 'warn'); }catch(_){}
        hero.src = './logo-invertido-fondo-oscuro.png';
      });
    }

    // Fecha por defecto = hoy, y no permitir futuro
    const fechaEl = $('#fecha');
    if(fechaEl){ const today = toYMD(new Date()); fechaEl.value = today; fechaEl.max = today; }

    // Cliente por URL ?cliente=... / ?client_id=...
    const params = new URLSearchParams(location.search);
    const urlCliente = params.get('cliente') || params.get('client_id') || params.get('client') || params.get('id');
    if(urlCliente){ CONFIG.CLIENTE_ID = sanitizeClienteId(urlCliente); }
    const cBadge = $('#cliente-badge');
    if(CONFIG.CLIENTE_ID && cBadge){ cBadge.style.display='inline-block'; cBadge.textContent = `Cliente: ${CONFIG.CLIENTE_ID}`; }

    // Adapter (Google Sheets)
    state.adapter = pickAdapter();
    await loadEntries(state.adapter);
  })();
  </script>
</body>
</html>
