<!doctype html>
}catch(err){ console.error(err); showToast('No se pudo eliminar.', 'error'); }
}


function exportCSV(){
const rows = [['fecha','peso']];
const sorted = [...state.entries].sort((a,b)=>{
const ai = a.iso ? Date.parse(a.iso) : Date.now();
const bi = b.iso ? Date.parse(b.iso) : Date.now();
return bi - ai;
});
for(const e of sorted){ rows.push([e.fecha, Number(e.peso).toFixed(1)]); }
const csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
const blob = new Blob(["\ufeff"+csv], {type:'text/csv;charset=utf-8;'});
const a = document.createElement('a');
a.href = URL.createObjectURL(blob);
a.download = 'registros_peso.csv';
a.click();
URL.revokeObjectURL(a.href);
}


async function clearAll(){
const scope = state.adapter.id==='backend' ? (CONFIG.CLIENTE_ID ? `del BACKEND (cliente: ${CONFIG.CLIENTE_ID})` : 'del BACKEND (TODOS los usuarios)') : 'de este dispositivo';
if(!confirm(`Esto borrará TODOS los registros ${scope}. ¿Confirmas?`)) return;
try{
await state.adapter.clear();
state.entries = [];
render();
showToast('Registros borrados.');
}catch(err){ console.error(err); showToast('No se pudo borrar.', 'error'); }
}


// Delegación de eventos en la tabla
$('#tbody').addEventListener('click', (ev)=>{
const btn = ev.target.closest('button');
if(!btn) return;
const tr = ev.target.closest('tr');
const id = tr?.dataset?.id;
if(!id) return;
const action = btn.dataset.action;
if(action==='edit') startEdit(id);
if(action==='save') saveEdit(id);
if(action==='cancel') cancelEdit(id);
if(action==='delete') deleteEntry(id);
});


// Botones principales
$('#add-btn').addEventListener('click', (e)=>{ e.preventDefault(); addEntry(); });
$('#export-btn').addEventListener('click', (e)=>{ e.preventDefault(); exportCSV(); });
$('#clear-btn').addEventListener('click', (e)=>{ e.preventDefault(); clearAll(); });


// Inicialización
(async function init(){
// Fecha UI
$('#fecha').textContent = toDDMMYYYY(new Date());
// Cliente por URL ?cliente=... (opcional)
const urlCliente = new URLSearchParams(location.search).get('cliente');
if(urlCliente){ CONFIG.CLIENTE_ID = sanitizeClienteId(urlCliente); }
// Adapter
state.adapter = pickAdapter();
await loadEntries(state.adapter);
})();
</script>
</body>
</html>
