<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>JV · Registro diario de peso</title>
  <meta name="description" content="Registro de peso diario con fecha automática. Guarda en Google Sheets y exporta a CSV." />
  <link rel="icon" type="image/png" href="./favicon-512x512.png" />
  <style>
    /* Imágenes globales responsivas */
    img{max-width:100%; height:auto; display:block}

    :root{
      /* Paleta JV (azules) */
      --bg:#0b1220;          /* fondo principal (navy oscuro) */
      --card:#0f1726;        /* tarjetas */
      --muted:#a8c3e6;       /* texto secundario */
      --text:#eaf2ff;        /* texto principal */
      --accent:#17b2ff;      /* azul neón */
      --accent-2:#0f7fe6;    /* azul profundo */
      --danger:#d95252;      /* rojo */
      --warn:#e9b948;        /* ámbar */
      --border:#1e2a3f;      /* bordes */
      --focus:#5cc8ff;       /* foco accesible */
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif;
      background:
        radial-gradient(60% 40% at 20% 0%, rgba(23,178,255,.25), transparent 60%),
        linear-gradient(180deg, #0b1220, #0c1524 40%, #0b1220);
      color:var(--text);
      overflow-x:hidden;
    }
    .container{max-width:820px; margin:0 auto; padding:24px;}

    header.brand{display:grid; grid-template-columns: 1fr auto; gap:12px; align-items:center; margin-bottom:8px}
    .brand-left{display:flex; gap:12px; align-items:center; min-width:0}
    .brand-logo{width:clamp(120px, 32vw, 220px); height:auto; filter: drop-shadow(0 0 18px rgba(23,178,255,.45)); border-radius:12px; flex-shrink:0}
    .brand-text{display:flex; flex-direction:column; min-width:0}
    .brand-title{font-weight:800; letter-spacing:.6px; font-size:clamp(1rem, 2.2vw, 1.25rem); white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .brand-subtitle{color:var(--muted); font-size:clamp(.85rem, 1.8vw, .95rem)}
    .page-title{font-size:clamp(1.3rem, 2.6vw, 1.8rem); margin:6px 0 14px 0; letter-spacing:.2px}

    .badge{font-size:.85rem; padding:6px 10px; border:1px solid var(--border); border-radius:999px; color:var(--muted); justify-self:end}
    .status-ok{color:#d9f5ff; border-color:#174a7a; background:#0b2a44}
    .status-local{color:#e2f1ff; border-color:#2b4f7a; background:#0f253d}
    .status-error{color:#ffd7d7; border-color:#6b2c2c; background:#361112}

    .card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:16px; box-shadow: 0 10px 30px rgb(0 0 0 / 25%);}
    .stack{display:grid; gap:12px}
    label{font-weight:600; color:#d1d9e0}
    input[type="number"], input[type="text"], .fake-input{width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--border); background:#0b1526; color:var(--text); outline:none; transition: box-shadow .15s ease, border-color .15s ease}
    input:focus{box-shadow:0 0 0 3px rgba(92,200,255,.35); border-color:var(--accent-2)}
    .fake-input{display:flex; align-items:center; min-height:44px}
    .row{display:grid; grid-template-columns:1fr; gap:12px}
    @media (min-width:640px){ .row{ grid-template-columns: 1fr 1fr; } }
    @media (max-width:480px){ header.brand{grid-template-columns: 1fr;} .badge{justify-self:start} .page-title{margin-top:0} }

    .actions{display:flex; gap:8px; flex-wrap:wrap;}
    button{background:#16212e; border:1px solid var(--border); color:var(--text); padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600; letter-spacing:.2px; min-height:40px}
    button:hover{filter:brightness(1.08)}
    .btn-primary{background:linear-gradient(180deg, var(--accent), var(--accent-2)); border-color:var(--accent-2)}
    .btn-secondary{background:#101b2c}
    .btn-danger{background:linear-gradient(180deg, #a73c3c, #7c2e2e); border-color:#7c2e2e}
    .btn-ghost{background:transparent}

    .toolbar{display:flex; gap:8px; align-items:center; justify-content:space-between; margin-top:8px; flex-wrap:wrap}

    table{width:100%; border-collapse:separate; border-spacing:0 8px}
    thead th{font-size:.92rem; color:#c6d9f2; font-weight:700; text-align:left; padding:10px 8px}
    tbody td{background:#0a1424; border-top:1px solid #1a2740; border-bottom:1px solid #1a2740; padding:12px 8px; vertical-align:middle}
    tbody tr td:first-child{border-left:1px solid #1a2740; border-top-left-radius:12px; border-bottom-left-radius:12px}
    tbody tr td:last-child{border-right:1px solid #1a2740; border-top-right-radius:12px; border-bottom-right-radius:12px}
    tbody tr:hover td{background:#0c1a2e}

    .table-actions button{padding:6px 10px; font-size:.9rem}
    .muted{color:var(--muted)}
    .right{text-align:right}

    .toast{position:fixed; right:16px; bottom:16px; background:#111a24; color:var(--text); border:1px solid var(--border); padding:10px 14px; border-radius:12px; box-shadow:0 10px 20px rgb(0 0 0 / 30%)}
    .sr-only{position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0}
  </style>
</head>
<body>
  <div class="container">
    <header class="brand">
      <div class="brand-left">
        <img src="./logo-principal-encabezado-web.png" alt="Jaime Valencia — Entrenamiento personal, nutrición y programación online" class="brand-logo" loading="eager" />
        <div class="brand-text">
          <div class="brand-title">JAIME VALENCIA</div>
          <div class="brand-subtitle">Entrenamiento personal · Nutrición y programación online</div>
        </div>
      </div>
      <div class="badge" id="status-badge" aria-live="polite">Inicializando…</div>
    </header>

    <h1 class="page-title">Registro diario de peso</h1>

    <section class="card" aria-labelledby="form-title">
      <h2 id="form-title" class="sr-only">Añadir registro</h2>
      <div class="stack">
        <div class="row">
          <div>
            <label for="fecha">Fecha</label>
            <div class="fake-input" id="fecha" aria-live="polite"></div>
          </div>
          <div>
            <label for="peso">Peso corporal (kg)</label>
            <input id="peso" type="number" inputmode="decimal" step="0.1" min="0" placeholder="Ej.: 72.3" aria-describedby="peso-help" />
            <div class="muted" id="peso-help">Solo introduce el número. La fecha se añade automáticamente.</div>
          </div>
        </div>
        <div class="actions">
          <button class="btn-primary" id="add-btn">Añadir</button>
          <button class="btn-secondary" id="export-btn" title="Descargar registros en CSV">Exportar CSV</button>
          <button class="btn-danger" id="clear-btn" title="Borrar todos los registros">Borrar todo</button>
        </div>
      </div>
    </section>

    <section class="card" style="margin-top:12px" aria-labelledby="tabla-title">
      <h2 id="tabla-title" class="sr-only">Registros</h2>
      <div class="toolbar">
        <div class="lhs muted">Orden: más recientes primero</div>
      </div>
      <div style="overflow:auto; margin-top:8px; -webkit-overflow-scrolling:touch">
        <table aria-describedby="tabla-title">
          <thead>
            <tr>
              <th>Fecha</th>
              <th class="right">Peso (kg)</th>
              <th class="right">Acciones</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite" style="display:none"></div>
  <noscript><div class="container"><p>Esta aplicación requiere JavaScript para funcionar.</p></div></noscript>

  <script>
  // ======= CONFIG =======
  const CONFIG = {
    BACKEND_URL: "https://script.google.com/macros/s/AKfycbzt9_5QGvPyDPgqid0Vk2Gmr2ar-TBaGxnmumJ69korWeYyhfP3c4-rdLnCOIj_Jgrr/exec",
    STORAGE_MODE: 'backend',
    CLIENTE_ID: "",
  };

  // ======= Utils =======
  const $ = (s) => document.querySelector(s);
  const genId = () => (typeof crypto!=='undefined' && crypto.randomUUID) ? crypto.randomUUID() : ('id_'+Math.random().toString(36).slice(2,10));
  const toDDMMYYYY = (d)=>{ const dt=d instanceof Date?d:new Date(d); return String(dt.getDate()).padStart(2,'0')+"/"+String(dt.getMonth()+1).padStart(2,'0')+"/"+dt.getFullYear(); };
  const parseWeight = (x)=> Number(String(x??'').replace(',', '.').trim());
  const sanitizeClienteId = (s)=> String(s||'').toLowerCase().replace(/[^a-z0-9_-]/g,'').slice(0,64);
  function showToast(msg, kind='info'){
    const el=$('#toast'); if(!el) return; el.textContent=msg; el.style.display='block'; el.style.borderColor = kind==='error' ? '#7c2e2e' : (kind==='warn' ? '#8b6b20' : 'var(--border)'); clearTimeout(showToast._t); showToast._t=setTimeout(()=>el.style.display='none',4000);
  }

  // ======= Global error handlers =======
  window.addEventListener('error', (e)=>{ showToast('Error: '+(e.error?.message||e.message),'error'); });
  window.addEventListener('unhandledrejection', (e)=>{ showToast('Error: '+(e.reason?.message||e.reason),'error'); });

  // ======= Persistence adapters =======
  function createLocalAdapter(){
    const KEY='peso_registros_v1';
    const read = ()=> JSON.parse(localStorage.getItem(KEY)||'[]');
    const write = (arr)=> localStorage.setItem(KEY, JSON.stringify(arr));
    return { id:'local', async list(){return read();}, async add(entry){const a=read();a.push(entry);write(a);return entry;}, async update(id,patch){const a=read();const i=a.findIndex(x=>x.id===id); if(i>-1){a[i]={...a[i],...patch,iso:new Date().toISOString()}; write(a);} else throw new Error('ID no encontrado');}, async remove(id){write(read().filter(x=>x.id!==id));}, async clear(){write([]);} };
  }
  function withCliente(p){ const out={...p}; if(CONFIG.CLIENTE_ID) out.cliente=CONFIG.CLIENTE_ID; return out; }
  function createSheetsAdapter(url){
    async function api(payload){
      const ctrl = new AbortController();
      const t = setTimeout(()=>ctrl.abort(), 20000);
      const res = await fetch(url, { method:'POST', headers:{'Content-Type':'text/plain;charset=utf-8'}, body: JSON.stringify(payload), signal: ctrl.signal, mode:'cors', redirect:'follow' });
      clearTimeout(t);
      if(!res.ok) throw new Error('HTTP '+res.status);
      const text = await res.text();
      let json; try{ json = JSON.parse(text); }catch(_){ throw new Error('Respuesta no-JSON del backend'); }
      if(!json.ok) throw new Error(json.error||'Error backend');
      return json.data;
    }
    return { id:'backend', async list(){return api(withCliente({action:'list'}));}, async add(entry){return api(withCliente({action:'add', entry}));}, async update(id,patch){return api(withCliente({action:'update', id, ...patch}));}, async remove(id){return api(withCliente({action:'delete', id}));}, async clear(){return api(withCliente({action:'clear'}));} };
  }
  function pickAdapter(){
    const forceLocal = new URLSearchParams(location.search).get('backend')==='off' || CONFIG.STORAGE_MODE==='local';
    if(forceLocal) return createLocalAdapter();
    const url=(CONFIG.BACKEND_URL||'').trim();
    return url ? createSheetsAdapter(url) : createLocalAdapter();
  }

  // ======= App =======
  const state={ entries:[], adapter:null };
  function setStatus(kind,text){ const el=$('#status-badge'); if(!el) return; el.classList.remove('status-ok','status-local','status-error'); if(kind==='backend'){el.classList.add('status-ok'); el.textContent='Guardando en: Google Sheets';} else if(kind==='local'){el.classList.add('status-local'); el.textContent='Guardando en: Este dispositivo';} else { el.classList.add('status-error'); el.textContent = text||'Error de almacenamiento'; } }
  function render(){ const tbody=$('#tbody'); if(!tbody) return; tbody.innerHTML=''; const sorted=[...state.entries].sort((a,b)=> (Date.parse(b.iso||0) - Date.parse(a.iso||0))); for(const e of sorted){ const tr=document.createElement('tr'); tr.dataset.id=e.id; const tdF=document.createElement('td'); tdF.textContent=e.fecha; const tdP=document.createElement('td'); tdP.className='right'; tdP.textContent=Number(e.peso).toFixed(1); const tdA=document.createElement('td'); tdA.className='right table-actions'; tdA.innerHTML='<button class="btn-ghost" data-action="edit">Editar</button> <button class="btn-ghost" data-action="delete">Eliminar</button>'; tr.append(tdF,tdP,tdA); tbody.appendChild(tr);} }
  async function loadEntries(adapter){ try{ if(adapter.id==='backend' && !(CONFIG.BACKEND_URL||'').trim()) throw new Error('BACKEND_URL vacío'); const list=await adapter.list(); state.entries=Array.isArray(list)?list:[]; render(); setStatus(adapter.id==='backend'?'backend':'local'); } catch(err){ console.error('Fallo list()', err); setStatus('error','Error conectando con Google Sheets'); showToast('No se pudo conectar con Google Sheets. Revisa la URL y permisos del Web App.','error'); } }
  async function addEntry(){ const pesoInput=$('#peso'); const peso=parseWeight(pesoInput?.value); if(!(peso>0)){ showToast('Introduce un peso válido (> 0).','error'); pesoInput?.focus(); return; } const now=new Date(); const idBase=genId(); const id=CONFIG.CLIENTE_ID?`${CONFIG.CLIENTE_ID}:${idBase}`:idBase; const entry={ id, fecha: toDDMMYYYY(now), peso: Number(peso.toFixed(1)), iso: now.toISOString() }; try{ await state.adapter.add(entry); state.entries.push(entry); if(pesoInput) pesoInput.value=''; render(); showToast('Registro añadido.'); }catch(err){ console.error('add failed', err); showToast('No se pudo guardar el registro.','error'); } }
  function startEdit(id){ const tr=document.querySelector(`tr[data-id="${id}"]`); if(!tr) return; const tdP=tr.children[1]; const tdA=tr.children[2]; const curr=tdP.textContent; tdP.innerHTML=`<input type="number" step="0.1" min="0" value="${curr}" style="width:120px" aria-label="Peso" />`; tdA.innerHTML='<button class="btn-ghost" data-action="save">Guardar</button> <button class="btn-ghost" data-action="cancel">Cancelar</button>'; }
  async function saveEdit(id){ const tr=document.querySelector(`tr[data-id="${id}"]`); if(!tr) return; const input=tr.querySelector('input[type="number"]'); const peso=parseWeight(input.value); if(!(peso>0)){ showToast('Peso inválido.','error'); input.focus(); return; } try{ await state.adapter.update(id,{peso:Number(peso.toFixed(1))}); const i=state.entries.findIndex(e=>e.id===id); if(i>-1){ state.entries[i].peso=Number(peso.toFixed(1)); state.entries[i].iso=new Date().toISOString(); } render(); showToast('Registro actualizado.'); }catch(err){ console.error(err); showToast('No se pudo actualizar.','error'); } }
  function cancelEdit(){ render(); }
  async function deleteEntry(id){ if(!confirm('¿Seguro que deseas eliminar este registro?')) return; try{ await state.adapter.remove(id); state.entries=state.entries.filter(e=>e.id!==id); render(); showToast('Registro eliminado.'); }catch(err){ console.error(err); showToast('No se pudo eliminar.','error'); } }
  function exportCSV(){ const rows=[["fecha","peso"]]; const sorted=[...state.entries].sort((a,b)=>Date.parse(b.iso||0)-Date.parse(a.iso||0)); for(const e of sorted){ rows.push([e.fecha, Number(e.peso).toFixed(1)]); } const csv=rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n'); const blob=new Blob(["\ufeff"+csv],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='registros_peso.csv'; a.click(); URL.revokeObjectURL(a.href); }
  async function clearAll(){ const scope=state.adapter.id==='backend'?(CONFIG.CLIENTE_ID?`del BACKEND (cliente: ${CONFIG.CLIENTE_ID})`:'del BACKEND (TODOS los usuarios)'):'de este dispositivo'; if(!confirm(`Esto borrará TODOS los registros ${scope}. ¿Confirmas?`)) return; try{ await state.adapter.clear(); state.entries=[]; render(); showToast('Registros borrados.'); }catch(err){ console.error(err); showToast('No se pudo borrar.','error'); } }

  // Delegación de eventos tabla
  document.addEventListener('click', (ev)=>{
    const btn = ev.target.closest('button'); if(!btn) return;
    const tr = ev.target.closest('tr'); const id = tr?.dataset?.id; const action = btn.dataset.action;
    if(action==='edit') startEdit(id);
    if(action==='save') saveEdit(id);
    if(action==='cancel') cancelEdit(id);
    if(action==='delete') deleteEntry(id);
  });
  // Botones principales
  $('#add-btn')?.addEventListener('click', (e)=>{ e.preventDefault(); addEntry(); });
  $('#export-btn')?.addEventListener('click', (e)=>{ e.preventDefault(); exportCSV(); });
  $('#clear-btn')?.addEventListener('click', (e)=>{ e.preventDefault(); clearAll(); });

  // Init
  (async function init(){
    $('#fecha').textContent = toDDMMYYYY(new Date());
    const urlCliente = new URLSearchParams(location.search).get('cliente');
    if(urlCliente) CONFIG.CLIENTE_ID = sanitizeClienteId(urlCliente);
    state.adapter = pickAdapter();
    await loadEntries(state.adapter);
  })();
  </script>
</body>
</html>
