<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="./favicon-512x512.png" />
  <title>Registro diario de peso (Nutrición)</title>
  <meta name="description" content="Página simple para registrar peso corporal diario con fecha automática. Exporta a CSV. Compatible con Google Sheets o almacenamiento local." />
  <style>
    /* Imágenes globales responsivas */
    img{max-width:100%; height:auto; display:block}

    :root{
      /* Paleta JV (azules) */
      --bg:#0b1220;          /* fondo principal (navy oscuro) */
      --card:#0f1726;        /* tarjetas */
      --muted:#a8c3e6;       /* texto secundario */
      --text:#eaf2ff;        /* texto principal */
      --accent:#17b2ff;      /* azul neón */
      --accent-2:#0f7fe6;    /* azul profundo */
      --danger:#d95252;      /* rojo */
      --warn:#e9b948;        /* ámbar */
      --border:#1e2a3f;      /* bordes */
      --focus:#5cc8ff;       /* foco accesible */
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif;
      background:
      radial-gradient(60% 40% at 20% 0%, rgba(23,178,255,.25), transparent 60%),
      linear-gradient(180deg, #0b1220, #0c1524 40%, #0b1220);
      color:var(--text);
      overflow-x:hidden;
    }
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif;
      background:
      radial-gradient(60% 40% at 20% 0%, rgba(23,178,255,.25), transparent 60%),
      linear-gradient(180deg, #0b1220, #0c1524 40%, #0b1220);
      color:var(--text);
    }
    .container{max-width:820px; margin:0 auto; padding:24px;}
    header{
      display:flex; gap:16px; align-items:center; justify-content:space-between; flex-wrap:wrap; margin-bottom:16px;
    }
    h1{font-size:clamp(1.2rem, 2.4vw, 1.8rem); margin:0; letter-spacing:0.2px}
    .badge{font-size:.85rem; padding:6px 10px; border:1px solid var(--border); border-radius:999px; color:var(--muted); justify-self:end}
    .status-ok{color:#c8f5dd; border-color:#2c6b50; background:#123928}
    .status-local{color:#e2f1ff; border-color:#2b4f7a; background:#0f253d}
    .status-error{color:#ffd7d7; border-color:#6b2c2c; background:#361112}

    .card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:16px; box-shadow: 0 10px 30px rgb(0 0 0 / 25%);}
    .stack{display:grid; gap:12px}
    label{font-weight:600; color:#d1d9e0}
    input[type="number"], input[type="text"], input[type="date"], .fake-input{
      width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--border); background:#0c1219; color:var(--text);
      outline:none; transition: box-shadow .15s ease, border-color .15s ease;
    }
    input:focus{box-shadow:0 0 0 3px rgb(154 209 255 / 35%); border-color:#3a78b8}
    .fake-input{display:flex; align-items:center; min-height:44px}
    .row{display:grid; grid-template-columns:1fr; gap:12px}
    @media (min-width:640px){ .row{ grid-template-columns: 1fr 1fr; } }
    @media (max-width:480px){
      header.brand{display:grid; grid-template-columns: 1fr auto; gap:8px 12px; align-items:center; margin-bottom:8px}
      .badge{justify-self:start}
      .page-title{font-size:clamp(1.3rem, 2.6vw, 1.8rem); margin:6px 0 14px 0; letter-spacing:.2px}
    }

    .actions{display:flex; gap:8px; flex-wrap:wrap;}
    button{
      background:#16212e; border:1px solid var(--border); color:var(--text); padding:10px 14px; border-radius:12px; cursor:pointer;
      font-weight:600; letter-spacing:.2px; min-height:40px;
    }
    button:hover{filter:brightness(1.08)}
    .btn-primary{background:linear-gradient(180deg, var(--accent), var(--accent-2)); border-color:var(--accent-2)}
    .btn-secondary{background:#152131}
    .btn-danger{background:linear-gradient(180deg, #a73c3c, #7c2e2e); border-color:#7c2e2e}
    .btn-ghost{background:transparent}

    .toolbar{display:flex; gap:8px; align-items:center; justify-content:space-between; margin-top:8px; flex-wrap:wrap;}
    .toolbar .lhs, .toolbar .rhs{display:flex; gap:8px; align-items:center;}

    table{width:100%; border-collapse:separate; border-spacing:0 8px;}
    thead th{font-size:.92rem; color:#c6d9f2; font-weight:700; text-align:left; padding:10px 8px}
    tbody td{background:#0a1424; border-top:1px solid #1a2740; border-bottom:1px solid #1a2740; padding:12px 8px; vertical-align:middle}
    tbody tr td:first-child{border-left:1px solid #172231; border-top-left-radius:12px; border-bottom-left-radius:12px}
    tbody tr td:last-child{border-right:1px solid #172231; border-top-right-radius:12px; border-bottom-right-radius:12px}

    .table-actions button{padding:6px 10px; font-size:.9rem}
    .muted{color:var(--muted)}
    .right{text-align:right}

    .toast{position:fixed; right:16px; bottom:16px; background:#111a24; color:var(--text); border:1px solid var(--border); padding:10px 14px; border-radius:12px; box-shadow:0 10px 20px rgb(0 0 0 / 30%)}
    .sr-only{position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0}

    
    
    pre.code{background:#0a0f14; border:1px solid var(--border); padding:12px; border-radius:12px; overflow:auto}
    code{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:.95em}
  /* ===== Estilos de marca JV ===== */
    header.brand{display:grid; grid-template-columns: 1fr auto; gap:12px; align-items:center; margin-bottom:8px}
    .brand-left{display:flex; gap:12px; align-items:center; min-width:0}
    .brand-logo{width:clamp(120px, 32vw, 220px); height:auto; filter: drop-shadow(0 0 18px rgba(23,178,255,.45)); border-radius:12px; flex-shrink:0}
    .brand-text{display:flex; flex-direction:column; min-width:0}
    .brand-title{font-weight:800; letter-spacing:.4px; font-size:clamp(1.05rem, 2.4vw, 1.4rem); line-height:1.15; white-space:normal; overflow:visible; text-overflow:clip}
    .brand-subtitle{color:var(--muted); font-size:clamp(.9rem, 2.1vw, 1.05rem); line-height:1.25}
    .page-title{font-size:clamp(1.3rem, 2.6vw, 1.8rem); margin:4px 0 14px 0; letter-spacing:.2px}

    /* Controles y tablas afinados a la paleta */
    input[type="number"], input[type="text"], input[type="date"], .fake-input{background:#0b1526}
    input:focus{box-shadow:0 0 0 3px rgba(92,200,255,.35); border-color:var(--accent-2)}
    .btn-secondary{background:#101b2c}
    thead th{color:#c6d9f2}
    tbody td{background:#0a1424; border-top-color:#1a2740; border-bottom-color:#1a2740}
    tbody tr:hover td{background:#0c1a2e}

    /* Badge según estado */
    .status-ok{color:#d9f5ff; border-color:#174a7a; background:#0b2a44}
    .status-local{color:#e2f1ff; border-color:#2b4f7a; background:#0f253d}
    .status-error{color:#ffd7d7; border-color:#6b2c2c; background:#361112}
  /* Marcas adicionales */
    .pill{border-color:var(--accent-2); color:#cfe9ff; background:rgba(23,178,255,.08)}
    body::after{content:""; position:fixed; inset:0; pointer-events:none; background: url('./logo-invertido-fondo-oscuro.png') no-repeat right -80px top -60px; background-size: 360px auto; opacity:.05}
  .brand-aside{display:grid; gap:6px; justify-items:end}
    @media (max-width:560px){
      header.brand{grid-template-columns:1fr}
      .brand-aside{justify-items:start}
    }
  </style>
</head>
<body>
  <!--
  =============================================================
  INSTRUCCIONES DE DESPLIEGUE RÁPIDO (LEER Y LUEGO BORRAR ESTE BLOQUE SI QUIERES)
  =============================================================
  1) BACKEND (Google Sheets + Apps Script)
     - Crea una hoja de cálculo de Google vacía. Opcional: renómbrala "Registro de peso".
     - Ve a Extensiones → Apps Script. Se abrirá el editor con un proyecto vinculado.
     - Borra el contenido y pega el código de Apps Script de más abajo (sección "CÓDIGO APPS SCRIPT").
     - Pulsa "Deploy" (Desplegar) → "New deployment" → "Web app".
       * Description: API Peso
       * Execute as: Me (tu cuenta)
       * Who has access: Anyone (o "Anyone with the link" / "Cualquiera")
       * Deploy y AUTORIZA los permisos.
     - Copia la URL del Web App (termina en /exec). Pégala en la constante BACKEND_URL más abajo en este archivo.
     - IMPORTANTE: Este método expone un endpoint abierto. Para mayor privacidad, despliega en una cuenta separada y rota la URL si se filtra. (Las apps script web requieren acceso abierto para funcionar desde un sitio estático.)

  2) FRONTEND (este archivo)
     - Guarda este archivo como index.html y súbelo a tu servicio de Pages (GitHub Pages, Netlify, etc.).
     - Edita el valor de BACKEND_URL en el bloque <script> inferior.

  3) PRUEBA RÁPIDA
     - Abre la página. Debes ver "Guardando en: Google Sheets" en la insignia de estado.
     - Añade un peso. Debería aparecer en la tabla. Comprueba que lo ves en la Hoja (pestaña "registros").
     - Exporta a CSV para verificar.

  4) NOTAS
     - Formato de fecha: DD/MM/YYYY. Unidad: kg. La fecha del formulario no es editable.
     - Si el backend falla, la app cae en modo local (datos en tu navegador) y verás el estado correspondiente.
  =============================================================

  CÓDIGO APPS SCRIPT (pégalo en el editor de Apps Script vinculada a la Hoja)
  -------------------------------------------------------------
  const SHEET_NAME = 'registros';

  function doGet(e){
    return doPost(e); // Permite pruebas con GET si mandas ?action=list
  }

  function doPost(e){
    try{
      var payload = {};
      if(e && e.postData && e.postData.contents){
        payload = JSON.parse(e.postData.contents);
      } else if (e && e.parameter && e.parameter.action){
        // Soporte simple para GET: /exec?action=list
        payload = e.parameter;
      }
      var action = String(payload.action || '').toLowerCase();
      var cliente = String(payload.cliente || '').trim();
      var sheet = getSheet_();

      if(action === 'list'){
        var data = list_(sheet, cliente);
        return json_({ok:true, data:data});
      }
      if(action === 'add'){
        var entry = payload.entry || {};
        if(!entry.id || !entry.fecha || entry.peso===undefined){ throw new Error('Faltan campos (id, fecha, peso)'); }
        if(cliente && String(entry.id).indexOf(cliente+':') !== 0){
          throw new Error('El id no coincide con el cliente');
        }
        sheet.appendRow([entry.id, entry.fecha, Number(entry.peso), entry.iso || new Date().toISOString()]);
        return json_({ok:true, data:entry});
      }
      if(action === 'update'){
        var id = payload.id;
        if(!id) throw new Error('Falta id');
        if(cliente && String(id).indexOf(cliente+':') !== 0) throw new Error('ID no pertenece a este cliente');
        var row = findRowById_(sheet, id);
        if(!row) throw new Error('ID no encontrado');
        if(payload.fecha){ sheet.getRange(row,2).setValue(payload.fecha); }
        if(payload.peso !== undefined){ sheet.getRange(row,3).setValue(Number(payload.peso)); }
        sheet.getRange(row,4).setValue(new Date().toISOString());
        return json_({ok:true});
      }
      if(action === 'delete'){
        var idd = payload.id;
        if(!idd) throw new Error('Falta id');
        if(cliente && String(idd).indexOf(cliente+':') !== 0) throw new Error('ID no pertenece a este cliente');
        var rowd = findRowById_(sheet, idd);
        if(!rowd) throw new Error('ID no encontrado');
        sheet.deleteRow(rowd);
        return json_({ok:true});
      }
      if(action === 'clear'){
        if(cliente){
          var count = clearCliente_(sheet, cliente);
          return json_({ok:true, cleared: count});
        } else {
          var last = sheet.getLastRow();
          if(last > 1){ sheet.getRange(2,1,last-1,sheet.getLastColumn()).clearContent(); }
          return json_({ok:true});
        }
      }

      throw new Error('Acción no soportada');
    }catch(err){
      console.error('Fallo list()', err);
      if(adapter.id==='backend'){
        if(CONFIG.STORAGE_MODE==='backend'){
          setStatus('error', 'Error conectando con Google Sheets');
          showToast('No se pudo conectar al backend. Revisa BACKEND_URL o permisos del Web App.', 'error');
        } else {
          // Fallback a local
          showToast('No se pudo conectar al backend. Usando almacenamiento local.', 'warn');
          state.adapter = createLocalAdapter();
          setStatus('local');
          state.entries = await state.adapter.list();
          render();
        }
      } else {
        setStatus('error', 'Error leyendo datos');
      }
    }
  function json_(obj){
    return ContentService.createTextOutput(JSON.stringify(obj))
      .setMimeType(ContentService.MimeType.JSON);
  }
  function getSheet_(){
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var sh = ss.getSheetByName(SHEET_NAME) || ss.insertSheet(SHEET_NAME);
    var headers = ['id','fecha','peso','iso'];
    if(sh.getLastRow() === 0){
      sh.appendRow(headers);
    } else {
      var existing = sh.getRange(1,1,1,headers.length).getValues()[0];
      if(existing.join() !== headers.join()){
        sh.getRange(1,1,1,headers.length).setValues([headers]);
      }
    }
    return sh;
  }
  function list_(sheet, cliente){
    var last = sheet.getLastRow();
    if(last < 2) return [];
    var values = sheet.getRange(2,1,last-1,4).getValues();
    var out = [];
    for(var i=0;i<values.length;i++){
      var r = values[i];
      if(!r[0]) continue;
      if(cliente && String(r[0]).indexOf(cliente+':') !== 0) continue;
      out.push({ id:String(r[0]), fecha:String(r[1]), peso:Number(r[2]), iso: String(r[3]||'') });
    }
    return out;
  }
  function findRowById_(sheet, id){
    var last = sheet.getLastRow();
    if(last < 2) return null;
    var values = sheet.getRange(2,1,last-1,1).getValues();
    for(var i=0;i<values.length;i++){
      if(String(values[i][0]) === String(id)) return i+2; // +2 por cabecera y base 1
    }
    return null;
  }
  function clearCliente_(sheet, cliente){
    var last = sheet.getLastRow();
    if(last < 2) return 0;
    var ids = sheet.getRange(2,1,last-1,1).getValues().map(function(v){ return String(v[0]||''); });
    var cleared = 0;
    for(var i=ids.length-1;i>=0;i--){
      if(ids[i].indexOf(cliente+':') === 0){
        sheet.deleteRow(i+2);
        cleared++;
      }
    }
    return cleared;
  }
  -------------------------------------------------------------
  FIN CÓDIGO APPS SCRIPT

  -->

  <div class="container">
    <header class="brand">
      <div class="brand-text">
        <div class="brand-title">JAIME VALENCIA</div>
        <div class="brand-subtitle">Entrenamiento personal · Nutrición y programación online</div>
      </div>
      <div class="brand-aside">
        <div class="badge" id="status-badge" aria-live="polite">Inicializando…</div>
        <div class="badge" id="cliente-badge" aria-live="polite" style="display:none"></div>
      </div>
    </header>

    <h1 class="page-title">Registro diario de peso</h1>

    <section class="card" aria-labelledby="form-title">
      <h2 id="form-title" class="sr-only">Añadir registro</h2>
      <div class="stack">
        <div class="row">
          <div>
            <label for="fecha">Fecha</label>
            <input id="fecha" type="date" aria-label="Fecha" />
          </div>
          <div>
            <label for="peso">Peso corporal (kg)</label>
            <input id="peso" type="number" inputmode="decimal" step="0.1" min="0" placeholder="Ej.: 72.3" aria-describedby="peso-help" />
            <div class="muted" id="peso-help">Solo introduce el número. La fecha se añade automáticamente.</div>
          </div>
        </div>
        <div class="actions">
          <button class="btn-primary" id="add-btn">Añadir</button>
          
          
        </div>
        
      </div>
    </section>

    <section class="card" style="margin-top:12px" aria-labelledby="tabla-title">
      <h2 id="tabla-title" class="sr-only">Registros</h2>
      <div class="toolbar">
        <div class="lhs muted">Orden: más recientes primero</div>
        <div class="rhs"></div>
      </div>
      <div style="overflow:auto; margin-top:8px; -webkit-overflow-scrolling:touch">
        <table aria-describedby="tabla-title">
          <thead>
            <tr>
              <th>Fecha</th>
              <th class="right">Peso (kg)</th>
              <th class="right">Acciones</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite" style="display:none"></div>

  <noscript>
    <div class="container"><p>Esta aplicación requiere JavaScript para funcionar.</p></div>
  </noscript>

  <script>
  /* ======================= CONFIGURACIÓN ======================= */
  const CONFIG = { 
    // 1) Pon aquí la URL del Web App de Apps Script (termina en /exec). Déjalo vacío para modo local.
    BACKEND_URL: "https://script.google.com/macros/s/AKfycbzt9_5QGvPyDPgqid0Vk2Gmr2ar-TBaGxnmumJ69korWeYyhfP3c4-rdLnCOIj_Jgrr/exec",
    // 2) No cambies el formato si quieres DD/MM/YYYY
    DATE_FORMAT: "DD/MM/YYYY",
    // 3) Forzar modo: 'auto' | 'backend' | 'local'
    STORAGE_MODE: 'backend',
    // 4) (Opcional) Segmentación por cliente/usuaria. Si lo defines, solo verás registros de ese cliente
    //    y los nuevos IDs se prefijarán así: CLIENTE_ID:UUID. También puedes usar ?cliente=tu-id en la URL.
    CLIENTE_ID: ""
  };

  /* ======================= UTILIDADES ======================= */
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  const genId = () => (typeof crypto!=='undefined' && crypto.randomUUID) ? crypto.randomUUID() : ('id_'+Math.random().toString(36).slice(2,10));

  function toDDMMYYYY(d){
    const dt = (d instanceof Date) ? d : new Date(d);
    const dd = String(dt.getDate()).padStart(2,'0');
    const mm = String(dt.getMonth()+1).padStart(2,'0');
    const yyyy = dt.getFullYear();
    return `${dd}/${mm}/${yyyy}`;
  }
  function toYMD(d){
    const dt = (d instanceof Date) ? d : new Date(d);
    const dd = String(dt.getDate()).padStart(2,'0');
    const mm = String(dt.getMonth()+1).padStart(2,'0');
    const yyyy = dt.getFullYear();
    return yyyy+'-'+mm+'-'+dd;
  }
  function ymdToDDMMYYYY(s){
    if(!s) return null;
    const parts = String(s).split('-');
    if(parts.length!==3) return null;
    const yyyy=parts[0], mm=parts[1], dd=parts[2];
    return dd+'/'+mm+'/'+yyyy;
  }
  function parseDDMMYYYY(str){
    const m = String(str||'').match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
    if(!m) return null;
    const [_, dd, mm, yyyy] = m;
    const date = new Date(Number(yyyy), Number(mm)-1, Number(dd));
    return isNaN(date) ? null : date;
  }
  function parseWeight(input){
    if(input===null || input===undefined) return NaN;
    const s = String(input).replace(',', '.').trim();
    return Number(s);
  }
  function sanitizeClienteId(s){
    return String(s||'').toLowerCase().replace(/[^a-z0-9_-]/g,'').slice(0,64);
  }
  function showToast(msg, kind='info'){
    const el = $('#toast');
    el.textContent = msg;
    el.style.display = 'block';
    el.style.borderColor = kind==='error' ? '#7c2e2e' : (kind==='warn' ? '#8b6b20' : 'var(--border)');
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=>{ el.style.display='none'; }, 3500);
  }
  // Errores globales para evitar pantallas en blanco
  window.addEventListener('error', (e)=>{ try{ showToast('Error: '+(e.error?.message||e.message), 'error'); }catch(_){} });
  window.addEventListener('unhandledrejection', (e)=>{ try{ showToast('Error: '+(e.reason?.message||e.reason), 'error'); }catch(_){} });

  /* ======================= ADAPTADORES DE PERSISTENCIA ======================= */
  function createLocalAdapter(){
    const KEY = 'peso_registros_v1';
    const read = () => JSON.parse(localStorage.getItem(KEY) || '[]');
    const write = (arr) => localStorage.setItem(KEY, JSON.stringify(arr));
    return {
      id: 'local',
      async list(){ return read(); },
      async add(entry){ const arr = read(); arr.push(entry); write(arr); return entry; },
      async update(id, patch){ const arr = read(); const i = arr.findIndex(x=>x.id===id); if(i>-1){ arr[i] = {...arr[i], ...patch, iso:new Date().toISOString() }; write(arr);} else { throw new Error('ID no encontrado'); } },
      async remove(id){ const arr = read().filter(x=>x.id!==id); write(arr); },
      async clear(){ write([]); }
    };
  }

  function createSheetsAdapter(url){
    async function api(payload){
      const ctrl = new AbortController();
      const t = setTimeout(()=> ctrl.abort(), 15000);
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify(payload),
        signal: ctrl.signal,
        mode: 'cors',
        redirect: 'follow'
      });
      clearTimeout(t);
      if(!res.ok){ throw new Error('HTTP '+res.status); }
      const text = await res.text();
      let json; try{ json = JSON.parse(text); }catch(_){ throw new Error('Respuesta no-JSON del backend'); }
      if(!json.ok){ throw new Error(json.error || 'Error desconocido'); }
      return json.data;
    }
    return {
      id: 'backend',
      async list(){ return await api(withCliente({action:'list'})); },
      async add(entry){ return await api(withCliente({action:'add', entry})); },
      async update(id, patch){ return await api(withCliente({action:'update', id, ...patch})); },
      async remove(id){ return await api(withCliente({action:'delete', id})); },
      async clear(){ return await api(withCliente({action:'clear'})); }
    };
  }

  function withCliente(payload){
    const p = {...payload};
    const cid = (CONFIG.CLIENTE_ID||'').trim();
    if(cid) p.cliente = cid;
    return p;
  }

  function pickAdapter(){
    const urlParam = new URLSearchParams(location.search).get('backend');
    const forceLocal = urlParam === 'off' || CONFIG.STORAGE_MODE==='local';
    const forceBackend = CONFIG.STORAGE_MODE==='backend';

    if(forceLocal){ return createLocalAdapter(); }
    const url = (CONFIG.BACKEND_URL || '').trim();
    if((url && !forceLocal) || forceBackend){ return createSheetsAdapter(url); }
    return createLocalAdapter();
  }

  /* ======================= APP ======================= */
  const state = { entries: [], adapter: null };

  function setStatus(kind, text){
    const el = $('#status-badge');
    el.classList.remove('status-ok','status-local','status-error');
    if(kind==='backend'){ el.classList.add('status-ok'); el.textContent = 'Guardando en: Google Sheets'; }
    else if(kind==='local'){ el.classList.add('status-local'); el.textContent = 'Guardando en: Este dispositivo'; }
    else { el.classList.add('status-error'); el.textContent = text || 'Error de almacenamiento'; }
  }

  function render(){
    const tbody = $('#tbody');
    tbody.innerHTML = '';
    const sorted = [...state.entries].sort((a,b)=>{
      const ai = a.iso ? Date.parse(a.iso) : (parseDDMMYYYY(a.fecha)||new Date(0));
      const bi = b.iso ? Date.parse(b.iso) : (parseDDMMYYYY(b.fecha)||new Date(0));
      return bi - ai; // descendente
    });
    for(const e of sorted){ tbody.appendChild(renderRow(e)); }
  }

  function renderRow(entry){
    const tr = document.createElement('tr');
    tr.dataset.id = entry.id;
    const tdFecha = document.createElement('td');
    tdFecha.textContent = entry.fecha;

    const tdPeso = document.createElement('td');
    tdPeso.className = 'right';
    tdPeso.textContent = Number(entry.peso).toFixed(1);

    const tdAct = document.createElement('td');
    tdAct.className = 'right table-actions';
    tdAct.innerHTML = `
      <button class="btn-ghost" data-action="edit" aria-label="Editar registro">Editar</button>
      <button class="btn-ghost" data-action="delete" aria-label="Eliminar registro">Eliminar</button>
    `;

    tr.append(tdFecha, tdPeso, tdAct);
    return tr;
  }

  async function loadEntries(adapter){
    try{
      const list = await adapter.list();
      state.entries = (Array.isArray(list) ? list : []);
      render();
      setStatus(adapter.id==='backend' ? 'backend' : 'local');
    }catch(err){
      console.error('Fallo list()', err);
      if(adapter.id==='backend'){
        // Fallback a local
        showToast('No se pudo conectar al backend. Usando almacenamiento local.', 'warn');
        state.adapter = createLocalAdapter();
        setStatus('local');
        state.entries = await state.adapter.list();
        render();
      } else {
        setStatus('error', 'Error leyendo datos');
      }
    }
  }

  async function addEntry(){
    const pesoRaw = $('#peso').value;
    const peso = parseWeight(pesoRaw);
    if(!(peso>0)){
      showToast('Introduce un peso válido (> 0).', 'error');
      $('#peso').focus();
      return;
    }
    const now = new Date();
    const fechaInput = $('#fecha');
    const fechaYMD = fechaInput && fechaInput.value ? fechaInput.value : toYMD(now);
    const fechaStr = ymdToDDMMYYYY(fechaYMD) || toDDMMYYYY(now);
    const baseId = genId();
    const compositeId = CONFIG.CLIENTE_ID ? `${CONFIG.CLIENTE_ID}:${baseId}` : baseId;
    const entry = { id: compositeId, fecha: fechaStr, peso: Number(peso.toFixed(1)), iso: now.toISOString() };
    try{
      await state.adapter.add(entry);
      state.entries.push(entry);
      $('#peso').value = '';
      render();
      showToast('Registro añadido.');
    }catch(err){
      console.error('add failed', err);
      showToast('No se pudo guardar el registro.', 'error');
    }
  }

  function startEdit(id){
    const tr = document.querySelector(`tr[data-id="${id}"]`);
    if(!tr) return;
    const tdPeso = tr.children[1];
    const tdAct = tr.children[2];
    const curr = tdPeso.textContent;
    tdPeso.innerHTML = `<input type="number" step="0.1" min="0" value="${curr}" style="width:120px" aria-label="Peso" />`;
    tdAct.innerHTML = `
      <button class="btn-ghost" data-action="save">Guardar</button>
      <button class="btn-ghost" data-action="cancel">Cancelar</button>
    `;
  }
  async function saveEdit(id){
    const tr = document.querySelector(`tr[data-id="${id}"]`);
    if(!tr) return;
    const input = tr.querySelector('input[type="number"]');
    const peso = parseWeight(input.value);
    if(!(peso>0)){ showToast('Peso inválido.', 'error'); input.focus(); return; }
    try{
      await state.adapter.update(id, {peso: Number(peso.toFixed(1))});
      const idx = state.entries.findIndex(e=>e.id===id);
      if(idx>-1){ state.entries[idx].peso = Number(peso.toFixed(1)); state.entries[idx].iso = new Date().toISOString(); }
      render();
      showToast('Registro actualizado.');
    }catch(err){ console.error(err); showToast('No se pudo actualizar.', 'error'); }
  }
  function cancelEdit(id){ render(); }

  async function deleteEntry(id){
    if(!confirm('¿Seguro que deseas eliminar este registro?')) return;
    try{
      await state.adapter.remove(id);
      state.entries = state.entries.filter(e=>e.id!==id);
      render();
      showToast('Registro eliminado.');
    }catch(err){ console.error(err); showToast('No se pudo eliminar.', 'error'); }
  }

  function exportCSV(){
    const rows = [['fecha','peso']];
    const sorted = [...state.entries].sort((a,b)=>{
      const ai = a.iso ? Date.parse(a.iso) : Date.now();
      const bi = b.iso ? Date.parse(b.iso) : Date.now();
      return bi - ai;
    });
    for(const e of sorted){ rows.push([e.fecha, Number(e.peso).toFixed(1)]); }
    const csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob(["\ufeff"+csv], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'registros_peso.csv';
    a.click();
    URL.revokeObjectURL(a.href);
  }

  async function clearAll(){
    const scope = state.adapter.id==='backend' ? (CONFIG.CLIENTE_ID ? `del BACKEND (cliente: ${CONFIG.CLIENTE_ID})` : 'del BACKEND (TODOS los usuarios)') : 'de este dispositivo';
    if(!confirm(`Esto borrará TODOS los registros ${scope}. ¿Confirmas?`)) return;
    try{
      await state.adapter.clear();
      state.entries = [];
      render();
      showToast('Registros borrados.');
    }catch(err){ console.error(err); showToast('No se pudo borrar.', 'error'); }
  }

  // Delegación de eventos en la tabla
  $('#tbody').addEventListener('click', (ev)=>{
    const btn = ev.target.closest('button');
    if(!btn) return;
    const tr = ev.target.closest('tr');
    const id = tr?.dataset?.id;
    if(!id) return;
    const action = btn.dataset.action;
    if(action==='edit') startEdit(id);
    if(action==='save') saveEdit(id);
    if(action==='cancel') cancelEdit(id);
    if(action==='delete') deleteEntry(id);
  });

  // Botones principales
  $('#add-btn').addEventListener('click', (e)=>{ e.preventDefault(); addEntry(); });

  // Inicialización
  (async function init(){
    // Fecha UI
    (function(){ const el=$('#fecha'); if(el){ const today=toYMD(new Date()); el.value=today; el.max=today; } })();
    // Cliente por URL ?cliente=... (opcional)
    const params = new URLSearchParams(location.search);
    const urlCliente = params.get('cliente') || params.get('client_id') || params.get('client') || params.get('id');
    if(urlCliente){ CONFIG.CLIENTE_ID = sanitizeClienteId(urlCliente); }
    const cBadge = document.getElementById('cliente-badge');
    if(CONFIG.CLIENTE_ID && cBadge){ cBadge.style.display='inline-block'; cBadge.textContent = `Cliente: ${CONFIG.CLIENTE_ID}`; }
    // Adapter
    state.adapter = pickAdapter();
    await loadEntries(state.adapter);
  })();
  </script>
</body>
</html>
